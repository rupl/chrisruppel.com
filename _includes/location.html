{% comment %}
  The spaces preceding each clause in the first conditional block are there
  mainly because my editorconfig strips trailing whitespace, and the only other
  way I knew how to force the space was with &nbsp; at the end of each output.
{% endcomment %}
{% capture location_full %}
{% if include.prep != null %}
  {{ include.prep }}
 {% elsif include.prep == null and include.location.prep != null %}
  {{ include.location.prep }}
 {% else %}
  in
 {% endif %}

{% if include.location.locality %}
{{ include.location.locality }}{% if include.location.region or include.location.country %}, {% endif %}
{% endif %}
{% if include.location.region %}
{{ include.location.region }}{% if include.location.country %}, {% endif %}
{% endif %}
{% if include.location.country %}{{ include.location.country }}{% endif %}
{% if include.location.locality == null and include.location.region == null and include.location.country == null and include.location.place %}{{ include.location.place }}{% endif %}
{% endcapture %}{{ location_full | strip_newlines | replace:'  ',' ' | replace:'  ',' ' | replace:'  ',' ' | replace:'  ',' ' }}