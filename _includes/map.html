{% include map-include.html %}

<!-- mapbox container -->
<div id='map-init' class='map'> </div>

<!-- mapbox init -->
<script>
  var map = L.mapbox.map('map-init', '{% if page.map.style %}{{ page.map.style }}{% else %}mapbox.streets{% endif %}');

  {% if page.map.kml %}
    var runLayer = omnivore.kml('/maps/{{ page.map.kml }}')
      .on('ready', function() {
          // Center map on the plot.
          map.fitBounds(runLayer.getBounds());

          // Set the styles for the plot.
          runLayer.setStyle({
            opacity: .75,
            weight: 6
          });

          // Tooltip for markers.
          // @see https://www.mapbox.com/mapbox.js/example/v1.0.0/omnivore-kml-tooltip/
          runLayer.eachLayer(function(layer) {
            layer.bindPopup('<h3>' + (layer.feature.properties.name || '') + '</h3><p>' + (layer.feature.properties.description || '') + '</p>');
          });
      })
      .addTo(map);
  {% else %}
    var geocoder = L.mapbox.geocoder('mapbox.places');
    geocoder.query('{{ page.map.location }}', showMap);

    function showMap(err, data) {
      // if (data.lbounds) {
      //     map.fitBounds(data.lbounds);
      //     var marker = L.marker([data.latlng[0], data.latlng[1]]).addTo(map);
      // } else if (data.latlng) {
        map.setView([data.latlng[0], data.latlng[1]], {{ page.map.zoom }});
        L.marker([data.latlng[0], data.latlng[1]]).addTo(map);
      // }
    }
  {% endif %}
</script>
